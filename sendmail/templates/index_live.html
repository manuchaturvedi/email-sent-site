{% extends "layout.html" %}

{% block title %}LinkedIn Email Automation{% endblock %}

{% block additional_styles %}
<style>
  .card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    color: #fff;
  }

  .input-group-text {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.05);
    color: #495057;
    font-weight: 500;
    border-radius: 12px 0 0 12px;
    padding: 0.75rem 1rem;
  }

  .form-control {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.05);
    color: #212529 !important;
    border-radius: 0 12px 12px 0;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    line-height: 1.5;
    transition: all 0.2s ease-in-out;
  }

  .form-control:focus {
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(0, 114, 255, 0.25);
    border-color: #0072ff;
    color: #000 !important;
  }

  .form-text {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.875rem;
    margin-top: 0.5rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, #0072ff 0%, #00c6ff 100%);
    border: none;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4);
    background: linear-gradient(135deg, #0081ff 0%, #00d4ff 100%);
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
  }

  .alert {
    border-radius: 12px;
    padding: 1rem;
    border: none;
  }

  .alert-info {
    background: rgba(0, 114, 255, 0.1);
    border-left: 4px solid #0072ff;
  }

  .alert-light {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .progress-container {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    height: 18px;
    overflow: hidden;
    margin-top: 10px;
  }

  .progress-bar {
    background: linear-gradient(90deg, #00c6ff, #0072ff);
    height: 100%;
    width: 0%;
    border-radius: 10px;
    transition: width 0.3s ease-in-out;
  }

  .progress-box {
    background: #0d1117;
    border-radius: 12px;
    padding: 15px;
    height: 250px;
    overflow-y: auto;
    font-family: "Fira Code", monospace;
    font-size: 14px;
    color: #b9dfff;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
    white-space: pre-wrap;
  }

  footer {
    text-align: center;
    color: #f1f5f9;
    opacity: 0.8;
    font-size: 0.9rem;
    margin-top: 20px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Welcome Section -->
  <div class="row mb-4">
    <div class="col-lg-8 mx-auto text-center">
      <h2 class="mb-3">LinkedIn Email Automation System</h2>
      <p class="lead text-muted">
        Streamline your job application process by automatically sending personalized emails to potential employers.
      </p>
    </div>
  </div>

  <!-- How it Works Section -->
  <div class="row mb-5">
    <div class="col-lg-8 mx-auto">
      <div class="card p-4 mb-4">
        <h5 class="mb-3"><i class="bi bi-info-circle-fill text-primary me-2"></i>How It Works</h5>
        <div class="row g-4">
          <div class="col-md-4">
            <div class="text-center p-3">
              <i class="bi bi-search-heart fs-2 text-primary mb-2"></i>
              <h6>1. Search & Find</h6>
              <p class="text-muted small">System searches LinkedIn for relevant job posts from the past week</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="text-center p-3">
              <i class="bi bi-envelope-paper fs-2 text-primary mb-2"></i>
              <h6>2. Extract & Prepare</h6>
              <p class="text-muted small">Extracts email addresses and prepares your personalized application</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="text-center p-3">
              <i class="bi bi-send-check fs-2 text-primary mb-2"></i>
              <h6>3. Send & Track</h6>
              <p class="text-muted small">Automatically sends emails and tracks the delivery status</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Form Section -->
  <div class="col-lg-6 col-md-8 mx-auto">
    <div class="card p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="bi bi-rocket-takeoff-fill fs-2 text-primary me-3"></i>
        <div>
          <h4 class="mb-1">Start Automation</h4>
          <p class="text-muted mb-0">Configure your email campaign below</p>
        </div>
      </div>

      <form id="automationForm" enctype="multipart/form-data">
        <div class="mb-4">
          <div class="alert alert-info d-flex align-items-center">
            <i class="bi bi-info-circle-fill fs-5 me-3"></i>
            <div>
              <strong>Email Configuration</strong><br>
              Emails will be sent from manudrive06@gmail.com with your email in CC
            </div>
          </div>
        </div>

        <!-- Email Subject -->
        <div class="mb-4">
          <label class="form-label" for="emailSubject">
            <i class="bi bi-card-text me-2"></i>Email Subject
            <span class="text-muted small ms-1">(Make it attention-grabbing)</span>
          </label>
          <div class="input-group input-group-lg">
            <input 
              type="text" 
              id="emailSubject" 
              name="subject" 
              class="form-control" 
              placeholder="e.g., Application for Senior DevOps Engineer Position" 
              required 
            />
          </div>
          <div class="form-text">A clear subject line increases your email's chances of being read</div>
        </div>

        <!-- Email Content -->
        <div class="mb-4">
          <label class="form-label" for="emailContent">
            <i class="bi bi-chat-dots me-2"></i>Email Body
            <span class="text-muted small ms-1">(Your pitch to the employer)</span>
          </label>
          <div class="input-group input-group-lg">
            <textarea 
              id="emailContent" 
              name="content" 
              class="form-control" 
              rows="6" 
              placeholder="Introduce yourself and explain why you're a great fit for the role..." 
              required
            ></textarea>
          </div>
          <div class="d-flex align-items-center mt-2">
            <a href="/profile" class="text-primary text-decoration-none small">
              <i class="bi bi-gear me-1"></i>Load template from profile
            </a>
            <span class="text-muted mx-2">‚Ä¢</span>
            <span class="text-muted small">Use {company} placeholder for company name</span>
          </div>
        </div>

        <!-- Resume Upload -->
        <div class="mb-4">
          <label class="form-label">
            <i class="bi bi-file-earmark-pdf me-2"></i>Resume
            <span class="text-muted small ms-1">(PDF format recommended)</span>
          </label>
          <div class="input-group input-group-lg">
            <input 
              type="file" 
              id="resumeFile" 
              name="resume" 
              class="form-control" 
              accept=".pdf,.doc,.docx" 
              required 
            />
          </div>
          <div id="savedResumeSection" class="mt-3 d-none">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="useSavedResume">
              <label class="form-check-label" for="useSavedResume">
                Use saved resume from profile instead
              </label>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="d-grid gap-2 mt-5">
          <button type="submit" id="runBtn" class="btn btn-primary btn-lg">
            <i class="bi bi-rocket-takeoff me-2"></i>Start Email Campaign
          </button>
          <div class="text-center text-muted small mt-2">
            The automation runs in the background and you'll see live progress below
          </div>
        </div>
      </form>

      <!-- Campaign Progress -->
      <div class="mt-5">
        <h5 class="d-flex align-items-center mb-4">
          <i class="bi bi-graph-up-arrow text-primary me-2"></i>
          Campaign Progress
        </h5>
        
        <!-- Stats Cards -->
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card h-100 bg-gradient">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <div class="icon-circle bg-info bg-opacity-10 me-3">
                    <i class="bi bi-envelope-paper-fill text-info"></i>
                  </div>
                  <h6 class="mb-0">Emails Found</h6>
                </div>
                <div class="d-flex align-items-baseline">
                  <h2 id="emailsFound" class="display-6 mb-0 me-2">0</h2>
                  <span class="text-muted small">contacts</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="card h-100 bg-gradient">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <div class="icon-circle bg-success bg-opacity-10 me-3">
                    <i class="bi bi-send-check-fill text-success"></i>
                  </div>
                  <h6 class="mb-0">Successfully Sent</h6>
                </div>
                <div class="d-flex align-items-baseline">
                  <h2 id="emailsSent" class="display-6 mb-0 me-2">0</h2>
                  <span class="text-muted small">emails</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="card h-100 bg-gradient">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                  <div class="icon-circle bg-warning bg-opacity-10 me-3">
                    <i class="bi bi-exclamation-diamond-fill text-warning"></i>
                  </div>
                  <h6 class="mb-0">Failed Attempts</h6>
                </div>
                <div class="d-flex align-items-baseline">
                  <h2 id="emailsFailed" class="display-6 mb-0 me-2">0</h2>
                  <span class="text-muted small">errors</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress Section -->
        <div class="card mt-4">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h6 class="mb-0">
                <i class="bi bi-terminal-fill text-primary me-2"></i>
                Real-time Progress
              </h6>
              <div class="badge bg-primary" id="progressStatus">Initializing...</div>
            </div>

            <!-- Progress Bar -->
            <div class="progress" style="height: 8px; border-radius: 4px;">
              <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"></div>
            </div>

            <!-- Progress Log -->
            <div class="mt-4">
              <div id="progressBox" class="progress-box"></div>
            </div>

            <!-- Email List Toggle -->
            <div class="mt-4 border-top pt-4">
              <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#emailList">
                <i class="bi bi-list-ul me-2"></i>View Detailed Email List
              </button>
              <div class="collapse mt-3" id="emailList">
                <div class="bg-dark rounded p-3">
                  <div id="emailListContent" class="small" style="font-family: 'Fira Code', monospace;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <style>
        .icon-circle {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .icon-circle i {
          font-size: 1.25rem;
        }
        .progress-box {
          max-height: 300px;
          overflow-y: auto;
        }
      </style>

      <footer>Developed by <b>Manu Chaturvedi</b> ‚Ä¢ Flask + Selenium LinkedIn Bot</footer>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const automationForm = document.getElementById('automationForm');
  const runBtn = document.getElementById('runBtn');
  const progressBox = document.getElementById('progressBox');
  const progressBar = document.getElementById('progressBar');
  const emailListContent = document.getElementById('emailListContent');
  
  // Load user profile data
  loadUserProfile();
  
  // Handle saved resume checkbox
  const useSavedResumeCheckbox = document.getElementById('useSavedResume');
  const resumeFileInput = document.getElementById('resumeFile');
  
  useSavedResumeCheckbox?.addEventListener('change', (e) => {
    resumeFileInput.required = !e.target.checked;
    if (e.target.checked) {
      resumeFileInput.disabled = true;
      resumeFileInput.value = '';
    } else {
      resumeFileInput.disabled = false;
    }
  });    // Global stats object
    window.stats = {
      emailsFound: 0,
      emailsSent: 0,
      emailsFailed: 0,
      emailList: new Set()
    };
    
    // Initialize event handlers
    automationForm.addEventListener('submit', handleSubmit);
  });

  function updateStats() {
    document.getElementById('emailsFound').textContent = window.stats.emailsFound;
    document.getElementById('emailsSent').textContent = window.stats.emailsSent;
    document.getElementById('emailsFailed').textContent = window.stats.emailsFailed;
    
    const emailList = Array.from(window.stats.emailList);
    document.getElementById('emailListContent').innerHTML = emailList.length ? `
      <div class="table-responsive">
        <table class="table table-sm table-dark mb-0">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Email Address</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody>
            ${emailList.map((email, index) => {
              const status = email.includes('‚úÖ') ? 'success' : email.includes('‚ùå') ? 'danger' : 'info';
              const statusText = status === 'success' ? 'Sent' : status === 'danger' ? 'Failed' : 'Pending';
              const cleanEmail = email.replace(/[‚úÖ‚ùå]/g, '').trim();
              return `
                <tr>
                  <td>${index + 1}</td>
                  <td><code>${cleanEmail}</code></td>
                  <td><span class="badge bg-${status}">${statusText}</span></td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    ` : '<div class="text-muted text-center">No emails processed yet</div>';
  }

  async function handleSubmit(e) {
    e.preventDefault();
    const runBtn = document.getElementById('runBtn');
    const progressBox = document.getElementById('progressBox');
    const progressBar = document.getElementById('progressBar');
    
    // Reset stats
    window.stats.emailsFound = 0;
    window.stats.emailsSent = 0;
    window.stats.emailsFailed = 0;
    window.stats.emailList.clear();
    updateStats();

    // Reset progress display
    progressBox.innerHTML = '';
    progressBar.style.width = '0%';
    progressBar.style.backgroundColor = '#0072ff';

    // Show loading state
    runBtn.disabled = true;
    runBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Running...';

    try {
      const formData = new FormData(e.target);
      // Add the useSavedResume flag
      const useSavedResume = document.getElementById('useSavedResume')?.checked || false;
      formData.append('useSavedResume', useSavedResume.toString());
      
      const response = await fetch('/run_automation', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      // Start listening for progress updates
      listenProgress();

    } catch (error) {
      console.error('Error:', error);
      progressBox.innerHTML += `\n‚ùå Error: ${error.message}`;
      runBtn.disabled = false;
      runBtn.innerHTML = '<i class="bi bi-play-circle me-2"></i>Run Automation';
    }
  }

  function addLogLine(msg) {
    const progressBox = document.getElementById('progressBox');
    const progressStatus = document.getElementById('progressStatus');
    progressBox.innerHTML += msg + "\n";
    progressBox.scrollTop = progressBox.scrollHeight;

    // Update progress status badge
    if (msg.includes('Starting automation')) {
      progressStatus.textContent = 'Searching...';
      progressStatus.className = 'badge bg-primary';
    }
    else if (msg.includes('üìß Found')) {
      progressStatus.textContent = 'Sending Emails...';
      progressStatus.className = 'badge bg-info';
      const match = msg.match(/Found (\d+) email/);
      if (match) {
        window.stats.emailsFound = parseInt(match[1]);
      }
    }
    else if (msg.includes('‚úÖ Sent to')) {
      progressStatus.textContent = 'Processing...';
      progressStatus.className = 'badge bg-primary';
      window.stats.emailsSent++;
      const email = msg.split('‚úÖ Sent to ')[1];
      if (email) window.stats.emailList.add(email);
    }
    else if (msg.includes('‚ùå Failed to send email to')) {
      window.stats.emailsFailed++;
      const email = msg.split('‚ùå Failed to send email to ')[1].split(':')[0];
      if (email) window.stats.emailList.add(email);
      if (window.stats.emailsFailed > 0) {
        progressStatus.textContent = 'Some Failures';
        progressStatus.className = 'badge bg-warning';
      }
    }
    else if (msg.includes('‚úÖ Automation completed successfully')) {
      progressStatus.textContent = 'Completed';
      progressStatus.className = 'badge bg-success';
    }

    updateStats();

    // Check for completion message
    if (msg.includes("‚úÖ Automation completed successfully")) {
      const runBtn = document.getElementById('runBtn');
      const progressBar = document.getElementById('progressBar');

      // Re-enable the run button
      runBtn.disabled = false;
      runBtn.innerHTML = '<i class="bi bi-play-circle me-2"></i>Run Automation';

      // Show completion status
      progressBar.style.width = "100%";
      if (window.stats.emailsFailed === 0) {
        progressBar.style.backgroundColor = "#28a745";
      }

      // Create completion toast
      const toastContainer = document.createElement('div');
      toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
      toastContainer.style.zIndex = '1050';
      
      const toastElement = document.createElement('div');
      const isSuccess = window.stats.emailsFailed === 0;
      toastElement.className = 'toast';
      toastElement.setAttribute('role', 'alert');
      toastElement.setAttribute('aria-live', 'assertive');
      toastElement.setAttribute('aria-atomic', 'true');
      
      toastElement.innerHTML = `
        <div class="toast-header">
          <div class="rounded-circle p-1 me-2 ${isSuccess ? 'bg-success' : 'bg-warning'}">
            <i class="bi bi-${isSuccess ? 'check-circle' : 'exclamation-circle'} text-white"></i>
          </div>
          <strong class="me-auto">Campaign Complete</strong>
          <small class="text-muted">just now</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-envelope text-primary me-2"></i>
            <div>Found <strong>${window.stats.emailsFound}</strong> potential contacts</div>
          </div>
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-send-check text-success me-2"></i>
            <div>Successfully sent <strong>${window.stats.emailsSent}</strong> emails</div>
          </div>
          ${window.stats.emailsFailed > 0 ? `
            <div class="d-flex align-items-center text-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <div><strong>${window.stats.emailsFailed}</strong> emails failed to send</div>
            </div>
          ` : ''}
          <hr>
          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-sm btn-secondary" data-bs-dismiss="toast">Dismiss</button>
            <button class="btn btn-sm btn-primary" onclick="document.querySelector('#emailList').classList.add('show')">
              View Details
            </button>
          </div>
        </div>
      `;
      
      toastContainer.appendChild(toastElement);
      document.body.appendChild(toastContainer);
      const toast = new bootstrap.Toast(toastElement, {
        animation: true,
        autohide: false
      });
      toast.show();

      // Clean up toast after it's hidden
      toast._element.addEventListener('hidden.bs.toast', () => {
        toast._element.remove();
      });
    }
  }

  async function loadUserProfile() {
    try {
      const response = await fetch('/get_profile');
      if (!response.ok) {
        throw new Error('Failed to load profile');
      }
      
      const profile = await response.json();
      
      // Fill form with profile data if available
      if (profile.emailSubject) {
        document.getElementById('emailSubject').value = profile.emailSubject;
      }
      if (profile.emailContent) {
        document.getElementById('emailContent').value = profile.emailContent;
      }
      if (profile.resumeFilename) {
        // Show the saved resume option
        const savedResumeSection = document.getElementById('savedResumeSection');
        savedResumeSection.classList.remove('d-none');
      }
      
    } catch (error) {
      console.error('Error loading profile:', error);
    }
  }

  function listenProgress() {
    const evtSource = new EventSource("/progress");
    const progressBar = document.getElementById('progressBar');
    
    evtSource.onmessage = function (event) {
      const data = event.data;

      // If a new job was saved, show a quick link to the Job Posts page
      if (data.startsWith("NEW_JOB:")) {
        addLogLine(data);
        if (!document.getElementById('viewJobsBtn')) {
          const container = document.createElement('div');
          container.id = 'viewJobsBtn';
          container.className = 'mt-3';
          container.innerHTML = `<a href="/jobs" target="_blank" class="btn btn-sm btn-outline-info">View Job Posts</a>`;
          // Append to card footer area
          const card = document.querySelector('.card');
          if (card) card.appendChild(container);
        }
        return;
      }

      // Handle progress bar updates
      if (data.startsWith("PROGRESS:")) {
        const percent = data.replace("PROGRESS:", "");
        progressBar.style.width = percent + "%";
        return;
      }

      addLogLine(data);

      if (data.includes("üèÅ")) {
        evtSource.close();
        const runBtn = document.getElementById('runBtn');
        runBtn.disabled = false;
        runBtn.innerHTML = '<i class="bi bi-play-circle me-2"></i>Run Again';
      }
    };
  }
</script>
{% endblock %}
