{% extends "layout.html" %}

{% block title %}LinkedIn Job Posts{% endblock %}

{% block additional_styles %}
.job-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    border-radius: 15px;
    border: none;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
    margin-bottom: 20px;
}

.job-card:hover {
    transform: translateY(-5px);
}

.job-title {
    color: #0072ff;
    font-weight: 600;
}

.company-name {
    color: #666;
    font-size: 0.9rem;
}

.job-description {
    color: #444;
    font-size: 0.95rem;
}

.post-date {
    color: #888;
    font-size: 0.85rem;
}

.badge {
    background: linear-gradient(90deg, #0072ff, #00c6ff);
    padding: 5px 10px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: 500;
}

.email-badge {
    background: #28a745;
}

.location-badge {
    background: #6c757d;
}
{% endblock %}

{% block content %}
        <div class="row mb-4">
            <div class="col">
                <h4><i class="bi bi-briefcase-fill me-2"></i>Recent Job Posts</h4>
                <p class="text-muted">Job posts from which emails were collected</p>
            </div>
        </div>

        <!-- Job Posts Table -->
        <div class="row mb-3">
            <div class="col-12">
                <!-- Filters -->
                <div class="card p-3 mb-3">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-5">
                            <input id="filterText" class="form-control" type="text" placeholder="Search description or email..." />
                        </div>
                        <div class="col-md-3">
                            <input id="filterFrom" class="form-control" type="date" placeholder="From" />
                        </div>
                        <div class="col-md-3">
                            <input id="filterTo" class="form-control" type="date" placeholder="To" />
                        </div>
                        <div class="col-md-1 text-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="filterHasEmail">
                                <label class="form-check-label small text-muted" for="filterHasEmail">
                                    Has email
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <button id="resetFilters" class="btn btn-sm btn-outline-secondary">Reset filters</button>
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="text-muted small">Showing <span id="visibleCount">0</span> of <strong id="totalCount">0</strong></span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="row" id="jobPostsContainer">
            <div class="col-12">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Description</th>
                                <th scope="col">Company</th>
                                <!-- Location column hidden for now -->
                                <th scope="col">Email</th>
                                <th scope="col">Posted</th>
                                <th scope="col">Link</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for post in job_posts %}
                            <tr>
                                <td class="desc-cell" style="max-width:460px; white-space:normal;">
                                    {{ post.description }}
                                    {% if post.skills %}
                                        <div class="mt-2">
                                            {% if post.skills is mapping %}
                                                <!-- Skills as dictionary -->
                                                {% for category, skills in post.skills.items() %}
                                                    {% for skill in skills %}
                                                        <span class="badge bg-info me-1">{{ skill }}</span>
                                                    {% endfor %}
                                                {% endfor %}
                                            {% else %}
                                                <!-- Skills as list -->
                                                {% for skill in post.skills %}
                                                    <span class="badge bg-info me-1">{{ skill }}</span>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="company-cell">{{ post.company if post.company else '-' }}</td>
                                <!-- location removed intentionally -->
                                <td class="email-cell" style="white-space:nowrap;">{% if post.email %}<a href="mailto:{{ post.email }}">{{ post.email }}</a>{% else %}-{% endif %}</td>
                                <td class="date-cell" style="white-space:nowrap;">{{ post.posted_date }}</td>
                                <td class="link-cell">{% if post.url %}<a href="{{ post.url }}" target="_blank">Open</a>{% else %}-{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    <script>
        // Client-side filtering for job posts table
        (function(){
            const filterText = document.getElementById('filterText');
            const filterFrom = document.getElementById('filterFrom');
            const filterTo = document.getElementById('filterTo');
            const filterHasEmail = document.getElementById('filterHasEmail');
            const resetBtn = document.getElementById('resetFilters');
            const visibleCount = document.getElementById('visibleCount');
            const totalCount = document.getElementById('totalCount');

            const table = document.querySelector('table.table tbody');
            if (!table) return;

            const rows = Array.from(table.querySelectorAll('tr'));
                totalCount.textContent = rows.length;
            visibleCount.textContent = rows.length;

            function parseDate(s){
                // Expect YYYY-MM-DD
                if(!s) return null;
                try{ return new Date(s); }catch{ return null; }
            }

            function matches(row){
                const q = filterText.value.trim().toLowerCase();
                const desc = row.querySelector('.desc-cell')?.textContent.trim().toLowerCase() || '';
                const email = row.querySelector('.email-cell')?.textContent.trim().toLowerCase() || '';
                const company = row.querySelector('.company-cell')?.textContent.trim().toLowerCase() || '';
                const dateStr = row.querySelector('.date-cell')?.textContent.trim() || '';

                // Text filter (search in description, email, or company)
                if (q){
                    if (!(desc.includes(q) || email.includes(q) || company.includes(q))) return false;
                }

                // Date range filter
                if (filterFrom.value){
                    const from = parseDate(filterFrom.value);
                    const rowDate = parseDate(dateStr);
                    if (rowDate && from && rowDate < from) return false;
                }
                if (filterTo.value){
                    const to = parseDate(filterTo.value);
                    const rowDate = parseDate(dateStr);
                    if (rowDate && to && rowDate > to) return false;
                }

                // Has email filter
                if (filterHasEmail.checked){
                    const emailCell = row.querySelector('.email-cell')?.textContent.trim() || '';
                    if (!emailCell || emailCell === '-') return false;
                }

                return true;
            }

            function applyFilters(){
                let visible = 0;
                rows.forEach(r => {
                    if (matches(r)){
                        r.style.display = '';
                        visible++;
                    } else {
                        r.style.display = 'none';
                    }
                });
                visibleCount.textContent = visible;
            }

            [filterText, filterFrom, filterTo, filterHasEmail].forEach(el => {
                if (el) el.addEventListener('input', applyFilters);
            });

            if (resetBtn) resetBtn.addEventListener('click', (e)=>{
                e.preventDefault();
                filterText.value = '';
                filterFrom.value = '';
                filterTo.value = '';
                filterHasEmail.checked = false;
                applyFilters();
            });

            // initial apply
            applyFilters();
        })();
    </script>
    </div>

{% endblock %}

{% block scripts %}
<script>
    // Client-side filtering for job posts table
    (function(){
        const filterText = document.getElementById('filterText');
        const filterFrom = document.getElementById('filterFrom');
        const filterTo = document.getElementById('filterTo');
        const filterHasEmail = document.getElementById('filterHasEmail');
        const resetBtn = document.getElementById('resetFilters');
        const visibleCount = document.getElementById('visibleCount');
        const totalCount = document.getElementById('totalCount');

        const table = document.querySelector('table.table tbody');
        if (!table) return;

        const rows = Array.from(table.querySelectorAll('tr'));
        totalCount.textContent = rows.length;
        visibleCount.textContent = rows.length;

        function parseDate(s){
            if(!s) return null;
            try { return new Date(s); } catch { return null; }
        }

        function matches(row){
            const q = filterText.value.trim().toLowerCase();
            const desc = row.querySelector('.desc-cell')?.textContent.trim().toLowerCase() || '';
            const email = row.querySelector('.email-cell')?.textContent.trim().toLowerCase() || '';
            const dateStr = row.querySelector('.date-cell')?.textContent.trim() || '';

            if (q && !(desc.includes(q) || email.includes(q))) return false;
            
            if (filterFrom.value){
                const from = parseDate(filterFrom.value);
                const rowDate = parseDate(dateStr);
                if (rowDate && from && rowDate < from) return false;
            }
            
            if (filterTo.value){
                const to = parseDate(filterTo.value);
                const rowDate = parseDate(dateStr);
                if (rowDate && to && rowDate > to) return false;
            }

            if (filterHasEmail.checked){
                const emailCell = row.querySelector('.email-cell')?.textContent.trim() || '';
                if (!emailCell || emailCell === '-') return false;
            }

            return true;
        }

        function applyFilters(){
            let visible = 0;
            rows.forEach(r => {
                if (matches(r)){
                    r.style.display = '';
                    visible++;
                } else {
                    r.style.display = 'none';
                }
            });
            visibleCount.textContent = visible;
        }

        [filterText, filterFrom, filterTo, filterHasEmail].forEach(el => {
            if (el) el.addEventListener('input', applyFilters);
        });

        if (resetBtn) resetBtn.addEventListener('click', (e)=>{
            e.preventDefault();
            filterText.value = '';
            filterFrom.value = '';
            filterTo.value = '';
            filterHasEmail.checked = false;
            applyFilters();
        });

        // initial apply
        applyFilters();
    })();
</script>
{% endblock %}